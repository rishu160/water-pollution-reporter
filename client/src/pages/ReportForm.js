import React, { useState } from 'react';
import { useForm } from 'react-hook-form';
import { toast } from 'react-toastify';
import axios from 'axios';

const ReportForm = () => {
  const { register, handleSubmit, reset, formState: { errors } } = useForm();
  const [photos, setPhotos] = useState([]);
  const [location, setLocation] = useState(null);
  const [loading, setLoading] = useState(false);
  const [showCamera, setShowCamera] = useState(false);
  const [stream, setStream] = useState(null);

  const getCurrentLocation = () => {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          setLocation({
            latitude: position.coords.latitude,
            longitude: position.coords.longitude
          });
          toast.success('‡§≤‡•ã‡§ï‡•á‡§∂‡§® ‡§Æ‡§ø‡§≤ ‡§ó‡§à!');
        },
        (error) => {
          toast.error('‡§≤‡•ã‡§ï‡•á‡§∂‡§® ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤ ‡§∏‡§ï‡•Ä‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§Æ‡•à‡§®‡•ç‡§Ø‡•Å‡§Ö‡§≤ ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§¶‡•á‡§Ç‡•§');
        }
      );
    } else {
      toast.error('‡§Ü‡§™‡§ï‡§æ ‡§¨‡•ç‡§∞‡§æ‡§â‡§ú‡§º‡§∞ ‡§ú‡•Ä‡§™‡•Ä‡§è‡§∏ ‡§∏‡§™‡•ã‡§∞‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§∞‡§§‡§æ‡•§');
    }
  };

  const handlePhotoChange = (e) => {
    const files = Array.from(e.target.files);
    if (files.length > 5) {
      toast.error('Maximum 5 photos allowed');
      return;
    }
    setPhotos(files);
  };

  const startCamera = async () => {
    try {
      const mediaStream = await navigator.mediaDevices.getUserMedia({ 
        video: { facingMode: 'environment' }, 
        audio: false 
      });
      setStream(mediaStream);
      setShowCamera(true);
    } catch (error) {
      toast.error('Camera access denied or not available');
    }
  };

  const capturePhoto = () => {
    const video = document.getElementById('camera-video');
    const canvas = document.getElementById('camera-canvas');
    const context = canvas.getContext('2d');
    
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    context.drawImage(video, 0, 0);
    
    canvas.toBlob((blob) => {
      const file = new File([blob], `photo-${Date.now()}.jpg`, { type: 'image/jpeg' });
      setPhotos(prev => [...prev, file]);
      stopCamera();
      toast.success('Photo captured successfully!');
    }, 'image/jpeg', 0.8);
  };

  const stopCamera = () => {
    if (stream) {
      stream.getTracks().forEach(track => track.stop());
      setStream(null);
    }
    setShowCamera(false);
  };

  const onSubmit = async (data) => {
    if (!location) {
      toast.error('‡§ï‡•É‡§™‡§Ø‡§æ ‡§≤‡•ã‡§ï‡•á‡§∂‡§® ‡§¶‡•á‡§Ç');
      return;
    }

    setLoading(true);
    const formData = new FormData();
    
    // Add form data
    Object.keys(data).forEach(key => {
      formData.append(key, data[key]);
    });
    
    // Add location and reporter info
    formData.append('location', JSON.stringify(location));
    formData.append('reportedBy', JSON.stringify({
      name: data.reporterName,
      phone: data.reporterPhone,
      email: data.reporterEmail
    }));
    
    // Add photos
    photos.forEach(photo => {
      formData.append('photos', photo);
    });

    try {
      await axios.post('/api/reports', formData, {
        headers: { 'Content-Type': 'multipart/form-data' }
      });
      
      toast.success('‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§∏‡§¨‡§Æ‡§ø‡§ü ‡§π‡•ã ‡§ó‡§à!');
      reset();
      setPhotos([]);
      setLocation(null);
    } catch (error) {
      toast.error('‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§∏‡§¨‡§Æ‡§ø‡§ü ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§π‡•Å‡§à');
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="container">
      <div className="card">
        <h2>üö® Report Pollution</h2>
        <form onSubmit={handleSubmit(onSubmit)}>
          
          <div className="form-group">
            <label>Report Title *</label>
            <input
              type="text"
              className="form-control"
              {...register('title', { required: 'Title is required' })}
              placeholder="e.g: Garbage and dirt in pond"
            />
            {errors.title && <span style={{color: 'red'}}>{errors.title.message}</span>}
          </div>

          <div className="form-group">
            <label>‡§µ‡§ø‡§∏‡•ç‡§§‡•É‡§§ ‡§µ‡§ø‡§µ‡§∞‡§£ *</label>
            <textarea
              className="form-control"
              rows="4"
              {...register('description', { required: '‡§µ‡§ø‡§µ‡§∞‡§£ ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§π‡•à' })}
              placeholder="‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§ï‡§æ ‡§µ‡§ø‡§∏‡•ç‡§§‡•É‡§§ ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§¶‡•á‡§Ç..."
            />
            {errors.description && <span style={{color: 'red'}}>{errors.description.message}</span>}
          </div>

          <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px'}}>
            <div className="form-group">
              <label>‡§™‡•ç‡§∞‡§¶‡•Ç‡§∑‡§£ ‡§ï‡§æ ‡§∏‡•ç‡§§‡§∞ *</label>
              <select className="form-control" {...register('pollutionLevel', { required: true })}>
                <option value="">‡§ö‡•Å‡§®‡•á‡§Ç</option>
                <option value="Low">‡§ï‡§Æ</option>
                <option value="Medium">‡§Æ‡§ß‡•ç‡§Ø‡§Æ</option>
                <option value="High">‡§Ö‡§ß‡§ø‡§ï</option>
                <option value="Critical">‡§ó‡§Ç‡§≠‡•Ä‡§∞</option>
              </select>
            </div>

            <div className="form-group">
              <label>‡§ú‡§≤ ‡§®‡§ø‡§ï‡§æ‡§Ø ‡§ï‡§æ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞ *</label>
              <select className="form-control" {...register('waterBodyType', { required: true })}>
                <option value="">‡§ö‡•Å‡§®‡•á‡§Ç</option>
                <option value="River">‡§®‡§¶‡•Ä</option>
                <option value="Lake">‡§ù‡•Ä‡§≤</option>
                <option value="Pond">‡§§‡§æ‡§≤‡§æ‡§¨</option>
                <option value="Canal">‡§®‡§π‡§∞</option>
                <option value="Stream">‡§®‡§æ‡§≤‡§æ</option>
                <option value="Other">‡§Ö‡§®‡•ç‡§Ø</option>
              </select>
            </div>
          </div>

          <div className="form-group">
            <label>Upload Photos (Maximum 5)</label>
            <div style={{display: 'flex', gap: '10px', marginBottom: '10px'}}>
              <button
                type="button"
                className="btn btn-success"
                onClick={startCamera}
                disabled={showCamera}
              >
                üì∑ Take Photo
              </button>
              <input
                type="file"
                className="form-control"
                multiple
                accept="image/*"
                onChange={handlePhotoChange}
                style={{flex: 1}}
              />
            </div>
            
            {showCamera && (
              <div style={{marginBottom: '20px', textAlign: 'center'}}>
                <video 
                  id="camera-video" 
                  autoPlay 
                  playsInline
                  ref={(video) => {
                    if (video && stream) {
                      video.srcObject = stream;
                    }
                  }}
                  style={{width: '100%', maxWidth: '400px', border: '2px solid #007bff', borderRadius: '8px'}}
                />
                <canvas id="camera-canvas" style={{display: 'none'}} />
                <div style={{marginTop: '10px'}}>
                  <button
                    type="button"
                    className="btn btn-primary"
                    onClick={capturePhoto}
                    style={{marginRight: '10px'}}
                  >
                    üì∏ Capture
                  </button>
                  <button
                    type="button"
                    className="btn btn-secondary"
                    onClick={stopCamera}
                  >
                    ‚ùå Cancel
                  </button>
                </div>
              </div>
            )}
            
            {photos.length > 0 && (
              <div style={{marginTop: '10px'}}>
                <div style={{color: '#666', marginBottom: '10px'}}>
                  {photos.length} photos selected
                </div>
                <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(100px, 1fr))', gap: '10px'}}>
                  {photos.map((photo, index) => (
                    <div key={index} style={{position: 'relative'}}>
                      <img 
                        src={URL.createObjectURL(photo)} 
                        alt={`Preview ${index + 1}`}
                        style={{width: '100%', height: '80px', objectFit: 'cover', borderRadius: '4px'}}
                      />
                      <button
                        type="button"
                        onClick={() => setPhotos(photos.filter((_, i) => i !== index))}
                        style={{
                          position: 'absolute',
                          top: '-5px',
                          right: '-5px',
                          background: 'red',
                          color: 'white',
                          border: 'none',
                          borderRadius: '50%',
                          width: '20px',
                          height: '20px',
                          fontSize: '12px',
                          cursor: 'pointer'
                        }}
                      >
                        √ó
                      </button>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>

          <div className="form-group">
            <label>‡§∏‡•ç‡§•‡§æ‡§® ‡§ï‡•Ä ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä *</label>
            <div style={{display: 'flex', gap: '10px', alignItems: 'center'}}>
              <button
                type="button"
                className="btn btn-success"
                onClick={getCurrentLocation}
              >
                üìç ‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§∏‡•ç‡§•‡§æ‡§® ‡§≤‡•á‡§Ç
              </button>
              {location && (
                <span style={{color: 'green'}}>
                  ‚úÖ ‡§∏‡•ç‡§•‡§æ‡§® ‡§Æ‡§ø‡§≤ ‡§ó‡§à ({location.latitude.toFixed(4)}, {location.longitude.toFixed(4)})
                </span>
              )}
            </div>
            <input
              type="text"
              className="form-control"
              {...register('address')}
              placeholder="‡§™‡§§‡§æ ‡§Ø‡§æ ‡§∏‡•ç‡§•‡§æ‡§® ‡§ï‡§æ ‡§®‡§æ‡§Æ (‡§µ‡•à‡§ï‡§≤‡•ç‡§™‡§ø‡§ï)"
              style={{marginTop: '10px'}}
            />
          </div>

          <h3>‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü‡§∞ ‡§ï‡•Ä ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä</h3>
          
          <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px'}}>
            <div className="form-group">
              <label>‡§®‡§æ‡§Æ</label>
              <input
                type="text"
                className="form-control"
                {...register('reporterName')}
                placeholder="‡§Ü‡§™‡§ï‡§æ ‡§®‡§æ‡§Æ"
              />
            </div>

            <div className="form-group">
              <label>‡§´‡•ã‡§® ‡§®‡§Ç‡§¨‡§∞</label>
              <input
                type="tel"
                className="form-control"
                {...register('reporterPhone')}
                placeholder="‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞"
              />
            </div>
          </div>

          <div className="form-group">
            <label>‡§à‡§Æ‡•á‡§≤</label>
            <input
              type="email"
              className="form-control"
              {...register('reporterEmail')}
              placeholder="‡§à‡§Æ‡•á‡§≤ ‡§™‡§§‡§æ (‡§µ‡•à‡§ï‡§≤‡•ç‡§™‡§ø‡§ï)"
            />
          </div>

          <button
            type="submit"
            className="btn btn-primary"
            disabled={loading}
            style={{width: '100%', padding: '15px', fontSize: '18px'}}
          >
            {loading ? '‚è≥ ‡§∏‡§¨‡§Æ‡§ø‡§ü ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à...' : 'üì§ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§∏‡§¨‡§Æ‡§ø‡§ü ‡§ï‡§∞‡•á‡§Ç'}
          </button>
        </form>
      </div>
    </div>
  );
};

export default ReportForm;